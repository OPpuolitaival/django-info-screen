{% load i18n %}

<!DOCTYPE html>
{% load staticfiles %}
<html lang="{{ LANGUAGE_CODE|default:"en" }}">
<head>
    <title>{{ title.title }}</title>
    <meta charset="UTF-8">
</head>

<body>

<div class="content">{% trans "Loading.." %}</div>

<script type="text/javascript" src="{{ STATIC_URL }}jquery-2.1.4.min.js"></script>

<script type="text/javascript">
    $(document).ready(function () {
        var is_slideshow_page = {% if page.is_slideshow_page %}true{% else %}false{%endif%}
        var pageid = "{{ page.pk|default:"undefined" }}";
        var load_url = "{{ page.show_url|default:"" }}";
        if (load_url != "") {
            $(".content").load(load_url);
        }
        var timeout = {{ screen.delay_in_sec }}000;
        var same_page_loop_index = 0;

        // Infinite loop with delay
        var action = function () {

            // Load next page information from rest api
            rest_url = "{% url 'info_screen:api' %}?page_id=" + pageid + "&screen_uuid={{ screen.uuid }}";
            $.get(rest_url, function (data) {
                if (data == '{}') {
                    load_url = "";
                    $(".content").html("{% trans "No visible page" %}");
                } else {
                    data = JSON.parse(data);
                    pageid = data.id;
                    load_url = data.url;
                    timeout = data.delay_in_sec * 1000;
                }
            });

            if (load_url != "") {
              if (is_slideshow_page == false){
                $(".content").load(load_url);
              }else{
                // Loop site so many times that error return code received
                $.get( load_url + '?page=' + (same_page_loop_index +1), function( data ) {
                    $( ".content" ).html( data );
                    same_page_loop_index++;
                }).fail(function() {
                    //Error during site loading
                    same_page_loop_index = 0;  // Reset loop index
                });
              }
            }
            setTimeout(action, timeout);
        };
        action();
    });
</script>

</body>
</html>
